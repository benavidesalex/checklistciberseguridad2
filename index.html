<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist de Ciberseguridad Personal</title>
    <style>
        /* Estilos Base y Tipograf√≠a */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #FFFFFF;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        h1 {
            color: #1A3E60;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .context-paragraph {
            text-align: center;
            margin: 10px 0 30px 0;
            padding: 15px 25px;
            background-color: #f0f8ff;
            border-left: 8px solid #007BFF;
            border-radius: 8px;
            color: #1A3E60;
            font-size: 1.05em;
            font-weight: 500;
            border: 1px solid #cceeff;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.15);
        }

        /* --- Estilos del Bot√≥n PDF --- */
        .pdf-button-container {
            text-align: center;
            margin-bottom: 25px;
        }

        #generatePdfButton {
            padding: 10px 20px;
            background-color: #C82333; /* Color rojo o de reporte */
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #generatePdfButton:hover {
            background-color: #A01C2A;
        }
        
        /* --- Report Header (Solo para PDF) --- */
        #reportHeader {
            display: none; /* Oculto por defecto */
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        #reportHeader h2 {
            margin: 0 0 5px 0;
            color: #1A3E60;
            font-size: 1.8em;
        }
        #reportHeader p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9em;
        }
        
        /* Contenedor Gr√°ficos: organiza el radar y los donuts */
        .charts-container {
            display: flex;
            flex-basis: 70%;
            justify-content: space-around;
            gap: 15px;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        
        /* Contenedor principal de resumen */
        .scores-summary-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #DDEBF6;
            border-radius: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            gap: 15px;
        }

        .overall-summary-block {
            flex-basis: 25%;
            min-width: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            background-color: #C0DFF0;
            border-radius: 5px;
        }

        .overall-score-top {
            font-size: 1.6em;
            font-weight: bold;
            color: #1A5276;
            text-align: center;
        }

        .overall-score-top span {
            color: #C82333;
            font-size: 1.2em;
        }
        /* ... (Resto de estilos, omitidos para brevedad, pero incluidos en el c√≥digo final) ... */

        /* ********************************************** */
        /* MEDIA QUERY PARA IMPRESI√ìN (GENERACI√ìN DE PDF) */
        /* ********************************************** */
        @media print {
            body {
                background-color: #fff;
                padding: 0;
            }
            .container {
                box-shadow: none;
                border: none;
                max-width: 100%;
                margin: 0;
                padding: 0;
            }
            
            /* OCULTAR ELEMENTOS INNECESARIOS */
            .context-paragraph,
            .checklist-grid,
            #openChatButton,
            #generatePdfButton,
            .modal,
            .modal-content,
            .modal-header,
            .modal-body {
                display: none !important;
            }
            
            /* MOSTRAR ENCABEZADO DE REPORTE */
            #reportHeader {
                display: block !important;
                border-bottom: 3px solid #1A3E60;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            
            /* AJUSTAR EL CONTENEDOR DE GR√ÅFICAS PARA IMPRESI√ìN */
            .scores-summary-top {
                background-color: #fff;
                box-shadow: none;
                border: 1px solid #ddd;
                flex-direction: row; 
                justify-content: center;
                gap: 50px;
            }
            
            .overall-summary-block {
                background-color: #f7f7f7;
                border: 1px solid #ccc;
            }

            .charts-container {
                flex-direction: row;
                align-items: center;
            }
            
            /* NUEVOS ESTILOS PARA EL DETALLE DEL REPORTE */
            #reportDetails {
                text-align: left;
                margin-top: 25px !important;
                padding: 10px 20px;
                border: 1px solid #eee;
                border-radius: 5px;
            }

            #reportDetails ul {
                list-style: none;
                padding: 0;
                margin: 10px 0;
                /* Crear 2 columnas para el listado */
                display: grid; 
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                font-size: 0.95em;
            }
            
            #reportDetails li {
                background-color: #f0f0f0;
                padding: 8px 12px;
                border-radius: 4px;
                border-left: 5px solid #007BFF;
                font-weight: bold;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            #reportDetails li span {
                color: #C82333;
                font-size: 1.1em;
            }

        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è Evaluaci√≥n de Ciberseguridad Personal</h1>

        <div class="pdf-button-container">
            <button id="generatePdfButton" onclick="generatePDF()">‚¨áÔ∏è Generar Reporte de Cumplimiento (PDF)</button>
        </div>
        
        <div id="reportHeader">
            <h2>Informe de Ciberseguridad Personal</h2>
            <p>Generado por: <span id="reportUserName">Usuario Desconocido</span></p>
            <p>Fecha de Evaluaci√≥n: <span id="reportDate"></span></p>
            <div class="overall-summary-block" style="margin: 20px auto; background-color: #e6f3ff;">
                <div class="overall-score-top">Puntuaci√≥n General: <span id="reportGeneralScore">0%</span></div>
            </div>
            <div id="reportDetails">
                </div>
        </div>

        <p class="context-paragraph">
            Este CheckList es una Evaluaci√≥n de Ciberseguridad gratuita y su prop√≥sito es proporcionarte asistencia y una "nota" en el √°mbito de la Ciberseguridad. Est√° dirigido tanto a usuarios sin experiencia previa como a aquellos que ya cuentan con conocimientos en la materia.
        </p>
        
        <div class="scores-summary-top">
            </div>
        <div class="checklist-grid">
            <div class="category-card" onclick="openModal('autenticacion')">
                <div class="card-header"><span class="icon">üîë</span> Autenticaci√≥n</div>
                <div class="card-body">
                    <div class="card-score" id="scoreAutenticacion">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedAutenticacion">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalAutenticacion">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="category-card" onclick="openModal('moviles')">
                <div class="card-header"><span class="icon">üì±</span> M√≥viles</div>
                <div class="card-body">
                    <div class="card-score" id="scoreMoviles">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedMoviles">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalMoviles">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="category-card" onclick="openModal('pc')">
                <div class="card-header"><span class="icon">üíª</span> PC y Escritorio</div>
                <div class="card-body">
                    <div class="card-score" id="scorePC">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedPC">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalPC">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="category-card" onclick="openModal('navegacion')">
                <div class="card-header"><span class="icon">üåê</span> Navegaci√≥n Web</div>
                <div class="card-body">
                    <div class="card-score" id="scoreNavegacion">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedNavegacion">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalNavegacion">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="category-card" onclick="openModal('correo')">
                <div class="card-header"><span class="icon">üìß</span> Correo Electr√≥nico</div>
                <div class="card-body">
                    <div class="card-score" id="scoreCorreo">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedCorreo">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalCorreo">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="category-card" onclick="openModal('respaldo')">
                <div class="card-header"><span class="icon">üíæ</span> Respaldo</div>
                <div class="card-body">
                    <div class="card-score" id="scoreRespaldo">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedRespaldo">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalRespaldo">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // **********************************************
        // 1. L√ìGICA DEL CHECKLIST (Datos, Persistencia, Gr√°ficas)
        // **********************************************

        const allChecklistData = {};
        const allLevels = ['basico', 'avanzado', 'opcional'];
        const totalItemsInLevel = {};
        const checkedItemsInLevel = {};
        let currentSection = ''; 

        // 1.1 Cargar datos del HTML a la estructura JS
        document.querySelectorAll('#hiddenChecklistData section').forEach(section => {
            const name = section.dataset.sectionname;
            const title = section.dataset.title;
            const items = [];
            section.querySelectorAll('.checklist-item').forEach(item => {
                const level = item.dataset.itemLevel;
                items.push({
                    id: item.querySelector('input[type="checkbox"]').id,
                    title: item.querySelector('.item-title').textContent,
                    detail: item.querySelector('.item-detail').textContent,
                    level: level,
                    checked: false
                });

                totalItemsInLevel[level] = (totalItemsInLevel[level] || 0) + 1;
            });
            allChecklistData[name] = { name, title, items };
        });

        // 1.2 Funciones de Utilidad
        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function getSectionIdSuffix(sectionName) {
            // FIX para 'pc' que en HTML es 'PC' (todo may√∫sculas)
            if (sectionName === 'pc') {
                return 'PC';
            }
            // Uso de PascalCase est√°ndar para el resto
            return capitalize(sectionName);
        }
        
        /**
         * NUEVA FUNCI√ìN: Obtiene la informaci√≥n de cumplimiento de cada secci√≥n.
         */
        function getSectionScores() {
            const scores = [];
            let totalChecked = 0;
            let totalTotal = 0;
            
            for (const sectionName in allChecklistData) {
                const section = allChecklistData[sectionName];
                let checkedInSection = 0;
                let totalInSection = section.items.length;

                section.items.forEach(item => { 
                    if (item.checked) checkedInSection++; 
                });
                
                totalChecked += checkedInSection;
                totalTotal += totalInSection;
                
                const score = totalInSection > 0 ? Math.round((checkedInSection / totalInSection) * 100) : 0;
                
                scores.push({
                    name: section.title.replace('Checklist de ', ''),
                    compliance: score,
                    total: totalInSection,
                    checked: checkedInSection
                });
            }
            
            const promedioGeneral = totalTotal > 0 ? Math.round((totalChecked / totalTotal) * 100) : 0;
            
            return { scores, promedioGeneral };
        }


        // 1.3 L√≥gica de Persistencia y Actualizaci√≥n (Gr√°ficas y Scores)
        function updateTotals() {
            let totalChecked = 0;
            let totalTotal = 0;

            allLevels.forEach(level => checkedItemsInLevel[level] = 0);

            for (const sectionName in allChecklistData) {
                const section = allChecklistData[sectionName];
                let checkedInSection = 0;
                let totalInSection = section.items.length;

                section.items.forEach(item => {
                    if (item.checked) {
                        checkedInSection++;
                        totalChecked++;
                        checkedItemsInLevel[item.level] = (checkedItemsInLevel[item.level] || 0) + 1;
                    }
                });

                totalTotal += totalInSection;
                const score = totalInSection > 0 ? Math.round((checkedInSection / totalInSection) * 100) : 0;
                
                // Determinar la clase de color/gravedad
                let scoreClass = 'high';
                if (score <= 30) {
                    scoreClass = 'low';
                } else if (score < 70) {
                    scoreClass = 'medium';
                }

                const suffix = getSectionIdSuffix(sectionName); 
                
                // Actualizar Tarjetas
                const scoreElement = document.getElementById(`score${suffix}`);
                const checkedElement = document.getElementById(`checked${suffix}`);
                const totalElement = document.getElementById(`total${suffix}`);

                if (scoreElement) {
                    scoreElement.textContent = `${score}%`;
                    scoreElement.className = `card-score ${scoreClass}`;
                }
                if (checkedElement) checkedElement.textContent = checkedInSection;
                if (totalElement) totalElement.textContent = totalInSection;
            }

            // Actualizar Resumen General
            const promedioGeneral = totalTotal > 0 ? Math.round((totalChecked / totalTotal) * 100) : 0;
            document.getElementById('promedioGeneral').textContent = `${promedioGeneral}%`;
            document.getElementById('totalCheckedItems').textContent = totalChecked;
            document.getElementById('totalItems').textContent = totalTotal;
            
            updateDonutCharts();
            updateRadarChart();
            saveState(); // Guardar el estado despu√©s de cada actualizaci√≥n
        }

        // ... (Resto de funciones: updateDonutCharts, updateRadarChart, openModal, saveAndCloseModal, etc., sin cambios relevantes) ...
        
        // 1.4 L√≥gica de Gr√°ficos (Donut Charts)
        function updateDonutCharts() {
            const circumference = 282.7; // 2 * PI * 45 (radio)
            allLevels.forEach(level => {
                const total = totalItemsInLevel[level] || 1;
                const checked = checkedItemsInLevel[level] || 0;
                const percentage = Math.round((checked / total) * 100);
                const offset = circumference - (percentage / 100) * circumference;

                document.getElementById(`donutPercent${capitalize(level)}`).textContent = `${percentage}%`;
                const circle = document.getElementById(`donutCircle${capitalize(level)}`);
                if (circle) circle.style.strokeDashoffset = offset;
            });
        }

        // 1.5 L√≥gica de Gr√°ficos (Radar Chart)
        function updateRadarChart() {
            const svg = document.getElementById('cyberRadarChart');
            const data = {};
            
            for (const sectionName in allChecklistData) {
                const section = allChecklistData[sectionName];
                let checkedInSection = 0;
                let totalInSection = section.items.length;
                section.items.forEach(item => { if (item.checked) checkedInSection++; });
                data[sectionName] = totalInSection > 0 ? (checkedInSection / totalInSection) : 0;
            }

            const sections = Object.keys(data);
            const numSections = sections.length;
            if (numSections === 0) return;

            const radius = 90;
            const center = 100;
            const angleStep = (2 * Math.PI) / numSections;

            svg.innerHTML = ''; // Limpiar el SVG

            let points = "";

            // Dibujar la figura del radar (la puntuaci√≥n)
            for (let i = 0; i < numSections; i++) {
                const angle = i * angleStep - Math.PI / 2;
                const score = data[sections[i]] || 0;
                const r = radius * score;
                const x = center + r * Math.cos(angle);
                const y = center + r * Math.sin(angle);
                points += `${x},${y} `;
                
                // Dibujar l√≠neas de eje y etiquetas
                const endX = center + radius * Math.cos(angle);
                const endY = center + radius * Math.sin(angle);
                
                // L√≠nea de Eje
                const axisLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                axisLine.setAttribute('x1', center);
                axisLine.setAttribute('y1', center);
                axisLine.setAttribute('x2', endX);
                axisLine.setAttribute('y2', endY);
                axisLine.setAttribute('class', 'radar-axis');
                svg.appendChild(axisLine);
                
                // Etiqueta
                const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
                const labelX = center + (radius * 1.1) * Math.cos(angle);
                const labelY = center + (radius * 1.1) * Math.sin(angle);

                label.setAttribute('x', labelX);
                label.setAttribute('y', labelY);
                label.setAttribute('class', 'radar-label');
                label.setAttribute('text-anchor', (Math.abs(Math.cos(angle)) < 0.1) ? 'middle' : (Math.cos(angle) > 0 ? 'start' : 'end'));
                label.textContent = capitalize(sections[i]);
                svg.appendChild(label);
            }

            const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            polygon.setAttribute('points', points);
            polygon.setAttribute('class', 'radar-shape');
            svg.appendChild(polygon);
        }
        
        function openModal(sectionName) {
            currentSection = sectionName;
            const modal = document.getElementById('checklistModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            const section = allChecklistData[sectionName];
            modalTitle.textContent = section.title;
            
            let htmlContent = '';
            let checkedCount = 0;

            section.items.forEach(item => {
                const isChecked = item.checked;
                if (isChecked) checkedCount++;
                
                htmlContent += `
                    <div class="checklist-item ${isChecked ? 'completed' : ''}" data-item-id="${item.id}">
                        <div class="checklist-row">
                            <input type="checkbox" id="modal_${item.id}" ${isChecked ? 'checked' : ''} onchange="updateModalScore('${sectionName}')">
                            <label for="modal_${item.id}" class="item-title">${item.title}</label>
                            <span class="level-tag level-${item.level}">${capitalize(item.level)}</span>
                        </div>
                        <div class="item-detail">${item.detail}</div>
                    </div>
                `;
            });

            modalBody.innerHTML = htmlContent;
            updateModalScore(sectionName, checkedCount);
            modal.style.display = 'block';
        }

        function updateModalScore(sectionName, initialCheckedCount) {
            const section = allChecklistData[sectionName];
            let checkedCount = initialCheckedCount !== undefined ? initialCheckedCount : 0;
            const total = section.items.length;
            const modalBody = document.getElementById('modalBody');
            
            if (initialCheckedCount === undefined) {
                // Si no se pasa el conteo inicial, lo calculamos en vivo desde los checkboxes del modal
                modalBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    if (checkbox.checked) checkedCount++;
                });
            }

            const score = total > 0 ? Math.round((checkedCount / total) * 100) : 0;
            document.getElementById('modalSectionScore').textContent = `${score}%`;
        }

        function saveAndCloseModal() {
            const modalBody = document.getElementById('modalBody');
            const section = allChecklistData[currentSection];

            section.items.forEach(item => {
                const checkbox = modalBody.querySelector(`#modal_${item.id}`);
                // Actualizar el estado del objeto en JS
                item.checked = checkbox.checked;
            });

            updateTotals();
            closeModal();
        }
        
        function clearCurrentSection() {
             const modalBody = document.getElementById('modalBody');
             modalBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                 checkbox.checked = false;
             });
             updateModalScore(currentSection, 0); 
        }

        function closeModal() {
            document.getElementById('checklistModal').style.display = 'none';
        }

        function loadState() {
            const savedState = localStorage.getItem('cybersecurityChecklistState');
            if (savedState) {
                const loadedData = JSON.parse(savedState);
                for (const sectionName in loadedData) {
                    if (allChecklistData[sectionName]) {
                        loadedData[sectionName].items.forEach((loadedItem, index) => {
                            if (allChecklistData[sectionName].items[index]) {
                                allChecklistData[sectionName].items[index].checked = loadedItem.checked;
                            }
                        });
                    }
                }
            }
        }

        function saveState() {
            localStorage.setItem('cybersecurityChecklistState', JSON.stringify(allChecklistData));
        }
        
        // **********************************************
        // 2. L√ìGICA DEL CHATBOT - INTEGRACI√ìN EXTERNA
        // **********************************************
        function openChatModal() {
            document.getElementById('chatModal').style.display = 'block';
        }

        function closeChatModal() {
            document.getElementById('chatModal').style.display = 'none';
        }
        
        // **********************************************
        // 3. L√ìGICA DE GENERACI√ìN DE PDF Y GOOGLE SHEETS
        // **********************************************
        
        // ** CAMBIA ESTA URL por la que obtengas al desplegar el Apps Script **
        const GAS_WEB_APP_URL = 'https://script.google.com/a/macros/energiasolarsa.com/s/AKfycbwu0pSdKjWs1oMwuD0c8x_JQNTcHUg1uPXF4_qCw8ex2yYmVPa1KlLu9tL-iNTx49wm/exec'; 

        /**
         * @function sendToGoogleSheet
         * Env√≠a los datos de cumplimiento a la hoja de Google Sheets a trav√©s del Apps Script.
         */
        function sendToGoogleSheet(userName, dateString, scoresData) {
            if (GAS_WEB_APP_URL === 'https://script.google.com/a/macros/energiasolarsa.com/s/AKfycbwu0pSdKjWs1oMwuD0c8x_JQNTcHUg1uPXF4_qCw8ex2yYmVPa1KlLu9tL-iNTx49wm/exec' || !GAS_WEB_APP_URL || GAS_WEB_APP_URL.length < 50) {
                console.warn("ADVERTENCIA: La URL de Apps Script no ha sido configurada o es incorrecta. Los datos NO se guardar√°n. Por favor, sigue las instrucciones de configuraci√≥n.");
                alert("Advertencia: No se guardaron los datos. Debes configurar la URL de Google Apps Script.");
                return;
            }

            const payload = {
                userName: userName,
                date: dateString,
                generalScore: scoresData.promedioGeneral,
                scores: scoresData.scores.map(s => ({
                    name: s.name,
                    compliance: s.compliance
                }))
            };
            
            // Se usa mode: 'no-cors' porque Apps Script no permite leer la respuesta de forma directa,
            // pero asegura que la solicitud se env√≠e.
            fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(() => {
                console.log('Datos de cumplimiento enviados a Google Sheets. (El navegador no puede confirmar la recepci√≥n)');
            })
            .catch(error => {
                console.error('Error al enviar datos a Google Sheets:', error);
            });
        }


        /**
         * @function generatePDF
         * Recopila datos, los env√≠a a Google Sheets y activa la impresi√≥n.
         */
        function generatePDF() {
            // 1. Pedir el nombre de usuario
            const userName = prompt("Por favor, introduce tu nombre para el informe y para guardar el registro:");
            
            if (!userName || userName.trim() === "") {
                alert("La generaci√≥n del reporte ha sido cancelada.");
                return;
            }
            
            const nameToDisplay = userName.trim();
            
            // 2. Obtener la fecha de hoy
            const today = new Date();
            const dateString = today.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // 3. Obtener todos los scores y el promedio general
            const scoresData = getSectionScores();
            const scores = scoresData.scores;
            const promedioGeneral = scoresData.promedioGeneral;

            // 4. Inyectar datos en el encabezado del reporte (para impresi√≥n)
            document.getElementById('reportUserName').textContent = nameToDisplay;
            document.getElementById('reportDate').textContent = dateString;
            document.getElementById('reportGeneralScore').textContent = `${promedioGeneral}%`;

            // 5. Inyectar la lista de scores por categor√≠a
            let scoresHtml = '<ul>';
            scores.forEach(score => {
                scoresHtml += `<li>${score.name} <span>${score.compliance}%</span></li>`;
            });
            scoresHtml += '</ul>';
            
            document.getElementById('reportDetails').innerHTML = `
                <h3 style="color: #1A3E60; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; font-size: 1.2em;">Cumplimiento por Categor√≠a</h3>
                ${scoresHtml}
            `;

            // 6. Enviar datos a Google Sheets (As√≠ncrono)
            sendToGoogleSheet(nameToDisplay, dateString, scoresData);
            
            // 7. Iniciar la impresi√≥n (navegador)
            // Peque√±o retraso para que el navegador procese el cambio de estilos de impresi√≥n
            setTimeout(() => {
                window.print();
            }, 100); 
        }

        // Inicializaci√≥n de la aplicaci√≥n
        loadState();
        updateTotals();
    </script>
    
    </body>
</html>
