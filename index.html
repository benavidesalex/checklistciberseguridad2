<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist de Ciberseguridad Personal</title>
    <style>
        /* Estilos Base y Tipograf√≠a */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #FFFFFF;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        h1 {
            color: #1A3E60;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .context-paragraph {
            text-align: center;
            margin: 10px 0 30px 0;
            padding: 15px 25px;
            background-color: #f0f8ff;
            border-left: 8px solid #007BFF;
            border-radius: 8px;
            color: #1A3E60;
            font-size: 1.05em;
            font-weight: 500;
            border: 1px solid #cceeff;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.15);
        }

        /* --- Estilos del Bot√≥n PDF --- */
        .pdf-button-container {
            text-align: center;
            margin-bottom: 25px;
        }

        #generatePdfButton {
            padding: 10px 20px;
            background-color: #C82333; /* Color rojo o de reporte */
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #generatePdfButton:hover {
            background-color: #A01C2A;
        }
        
        /* --- Report Header (Solo para PDF) --- */
        #reportHeader {
            display: none; /* Oculto por defecto */
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        #reportHeader h2 {
            margin: 0 0 5px 0;
            color: #1A3E60;
            font-size: 1.8em;
        }
        #reportHeader p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9em;
        }
        
        /* Contenedor principal de resumen (Overall Score + Donut Charts) */
        .scores-summary-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #DDEBF6;
            border-radius: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            gap: 25px; /* Aumentado el gap */
        }

        .overall-summary-block {
            flex-basis: 25%;
            min-width: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            background-color: #C0DFF0;
            border-radius: 5px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .overall-summary-block h3 {
            margin: 0 0 5px 0;
            font-size: 1.2em;
            color: #1A3E60;
        }

        .overall-score-top {
            font-size: 2.2em; /* Aumentado el tama√±o */
            font-weight: bold;
            color: #1A5276;
            text-align: center;
            margin: 5px 0;
        }

        .overall-score-top span {
            color: #C82333; /* Color de puntuaci√≥n */
            font-size: 1em;
        }
        
        /* Contenedor Gr√°ficos: organiza el radar y los donuts */
        .charts-container {
            display: flex;
            flex-basis: 70%;
            justify-content: space-around;
            gap: 15px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        /* --- Estilos de Donut Charts (por Nivel) --- */
        .donut-chart-container {
            text-align: center;
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 10px;
        }

        .donut-chart-container h4 {
            margin: 0;
            font-size: 0.9em;
            color: #1A5276;
        }

        .donut-chart-container p {
            font-size: 0.8em;
            margin: 0;
        }

        .donut-bg {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 10;
        }

        .donut-fg {
            fill: none;
            stroke-width: 10;
            stroke-dasharray: 282.7; /* 2 * PI * 45 */
            stroke-dashoffset: 282.7;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.5s ease-out;
            stroke-linecap: round;
        }

        .level-basico-fg { stroke: #28a745; }
        .level-avanzado-fg { stroke: #ffc107; }
        .level-opcional-fg { stroke: #007bff; }

        .donut-text {
            font-size: 16px;
            font-weight: bold;
            text-anchor: middle;
            fill: #333;
        }

        /* --- Estilos de Radar Chart (por Categor√≠a) --- */
        .radar-chart-block {
            flex-direction: column;
            width: 100%;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .radar-chart {
            display: block;
            margin: 0 auto;
            max-width: 400px;
            width: 100%;
        }

        .radar-grid {
            fill: #f5f5f5;
            stroke: #ccc;
            stroke-width: 1;
        }

        .radar-axis {
            stroke: #ccc;
            stroke-width: 1;
        }

        .radar-shape {
            fill: rgba(25, 135, 84, 0.6); /* Verde m√°s oscuro para la forma */
            stroke: #198754;
            stroke-width: 2;
        }

        .radar-label {
            font-size: 8px;
            fill: #333;
            font-weight: bold;
        }
        
        /* --- Estilos del Checklist Grid y Tarjetas --- */
        .checklist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .category-card {
            background-color: #FFFFFF;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: 1px solid #ddd;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background-color: #1A3E60;
            color: white;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .card-header .icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .card-body {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-score {
            font-size: 2em;
            font-weight: bold;
            color: #C82333; /* Rojo por defecto */
        }
        
        .card-score.low { color: #dc3545; } /* Rojo */
        .card-score.medium { color: #ffc107; } /* Amarillo */
        .card-score.high { color: #28a745; } /* Verde */

        .card-details {
            text-align: right;
        }

        .detail-group {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .detail-group span:first-child {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            display: block;
        }
        
        /* --- Estilos del Modal (Checklist en detalle) --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            color: #1A3E60;
            font-size: 1.5em;
        }
        
        .modal-score-header {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
        
        .modal-score-header .score-display {
            color: #C82333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }
        
        .checklist-item {
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px 15px;
            margin-bottom: 10px;
            transition: background-color 0.1s;
        }

        .checklist-item.completed {
            background-color: #e9f5e9;
            border-left: 5px solid #28a745;
        }
        
        .checklist-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .checklist-item input[type="checkbox"] {
            transform: scale(1.5);
            margin-right: 15px;
            cursor: pointer;
        }
        
        .checklist-item .item-title {
            flex-grow: 1;
            font-weight: bold;
            font-size: 1.05em;
            cursor: pointer;
            margin-right: 15px;
        }
        
        .checklist-item .item-detail {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
            padding-left: 35px; /* Alineaci√≥n con el texto */
        }
        
        .level-tag {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
        }

        .level-basico { background-color: #28a745; }
        .level-avanzado { background-color: #ffc107; color: #333; }
        .level-opcional { background-color: #007bff; }
        
        .modal-footer {
            display: flex;
            justify-content: space-between;
            padding-top: 15px;
            border-top: 1px solid #eee;
            margin-top: 15px;
        }
        
        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .save-button {
            background-color: #007BFF;
            color: white;
        }

        .save-button:hover {
            background-color: #0056b3;
        }

        .clear-button {
            background-color: #ccc;
            color: #333;
        }

        .clear-button:hover {
            background-color: #aaa;
        }

        /* ********************************************** */
        /* MEDIA QUERY PARA IMPRESI√ìN (GENERACI√ìN DE PDF) */
        /* ********************************************** */
        @media print {
            body {
                background-color: #fff;
                padding: 0;
            }
            .container {
                box-shadow: none;
                border: none;
                max-width: 100%;
                margin: 0;
                padding: 0;
            }
            
            /* OCULTAR ELEMENTOS INNECESARIOS */
            .context-paragraph,
            .checklist-grid,
            #openChatButton,
            #generatePdfButton,
            .modal,
            .modal-content,
            .modal-header,
            .modal-body {
                display: none !important;
            }
            
            /* MOSTRAR ENCABEZADO DE REPORTE */
            #reportHeader {
                display: block !important;
                border-bottom: 3px solid #1A3E60;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            
            /* AJUSTAR EL CONTENEDOR DE GR√ÅFICAS PARA IMPRESI√ìN */
            .scores-summary-top {
                background-color: #fff;
                box-shadow: none;
                border: 1px solid #ddd;
                flex-direction: row; 
                justify-content: center;
                gap: 50px;
                page-break-before: always;
            }
            
            .overall-summary-block {
                background-color: #f7f7f7;
                border: 1px solid #ccc;
            }

            .charts-container {
                flex-direction: row;
                align-items: center;
            }
            
            /* NUEVOS ESTILOS PARA EL DETALLE DEL REPORTE */
            #reportDetails {
                text-align: left;
                margin-top: 25px !important;
                padding: 10px 20px;
                border: 1px solid #eee;
                border-radius: 5px;
            }

            #reportDetails ul {
                list-style: none;
                padding: 0;
                margin: 10px 0;
                /* Crear 2 columnas para el listado */
                display: grid; 
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                font-size: 0.95em;
            }
            
            #reportDetails li {
                background-color: #f0f0f0;
                padding: 8px 12px;
                border-radius: 4px;
                border-left: 5px solid #007BFF;
                font-weight: bold;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            #reportDetails li span {
                color: #C82333;
                font-size: 1.1em;
            }

        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è Evaluaci√≥n de Ciberseguridad Personal</h1>

        <div class="pdf-button-container">
            <button id="generatePdfButton" onclick="generatePDF()">‚¨áÔ∏è Generar Reporte de Cumplimiento (PDF)</button>
        </div>
        
        <div id="reportHeader">
            <h2>Informe de Ciberseguridad Personal</h2>
            <p>Generado por: <span id="reportUserName">Usuario Desconocido</span></p>
            <p>Fecha de Evaluaci√≥n: <span id="reportDate"></span></p>
            <div class="overall-summary-block" style="margin: 20px auto; background-color: #e6f3ff;">
                <div class="overall-score-top">Puntuaci√≥n General: <span id="reportGeneralScore">0%</span></div>
            </div>
            <div id="reportDetails">
            </div>
        </div>

        <p class="context-paragraph">
            Este CheckList es una Evaluaci√≥n de Ciberseguridad gratuita y su prop√≥sito es proporcionarte asistencia y una "nota" en el √°mbito de la Ciberseguridad. Est√° dirigido tanto a usuarios sin experiencia previa como a aquellos que ya cuentan con conocimientos en la materia.
        </p>
        
        <div class="scores-summary-top">
            <div class="overall-summary-block">
                <h3>Puntuaci√≥n General</h3>
                <div class="overall-score-top"><span id="promedioGeneral">0%</span></div>
                <p>Total completados: <span id="totalCheckedItems">0</span>/<span id="totalItems">0</span></p>
            </div>

            <div class="charts-container">
                <div class="donut-chart-container">
                    <h4>Nivel B√°sico</h4>
                    <svg viewBox="0 0 100 100">
                        <circle class="donut-bg" cx="50" cy="50" r="45"></circle>
                        <circle id="donutCircleBasico" class="donut-fg level-basico-fg" cx="50" cy="50" r="45"></circle>
                        <text id="donutPercentBasico" class="donut-text" x="50" y="50">0%</text>
                    </svg>
                    <p>Completados</p>
                </div>

                <div class="donut-chart-container">
                    <h4>Nivel Avanzado</h4>
                    <svg viewBox="0 0 100 100">
                        <circle class="donut-bg" cx="50" cy="50" r="45"></circle>
                        <circle id="donutCircleAvanzado" class="donut-fg level-avanzado-fg" cx="50" cy="50" r="45"></circle>
                        <text id="donutPercentAvanzado" class="donut-text" x="50" y="50">0%</text>
                    </svg>
                    <p>Completados</p>
                </div>

                <div class="donut-chart-container">
                    <h4>Nivel Opcional</h4>
                    <svg viewBox="0 0 100 100">
                        <circle class="donut-bg" cx="50" cy="50" r="45"></circle>
                        <circle id="donutCircleOpcional" class="donut-fg level-opcional-fg" cx="50" cy="50" r="45"></circle>
                        <text id="donutPercentOpcional" class="donut-text" x="50" y="50">0%</text>
                    </svg>
                    <p>Completados</p>
                </div>
            </div>
        </div>

        <div class="charts-container radar-chart-block">
            <h3 style="text-align: center; color: #1A3E60; margin-top: 0px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">An√°lisis de Cumplimiento por √Årea</h3>
            <svg id="cyberRadarChart" viewBox="0 0 200 200" class="radar-chart">
                <circle class="radar-grid" cx="100" cy="100" r="90" fill="none" stroke="#ccc"/>
                <circle class="radar-grid" cx="100" cy="100" r="60" fill="none" stroke="#ddd"/>
                <circle class="radar-grid" cx="100" cy="100" r="30" fill="none" stroke="#eee"/>
            </svg>
        </div>


        <div class="checklist-grid">
            <div class="category-card" onclick="openModal('autenticacion')">
                <div class="card-header"><span class="icon">üîë</span> Autenticaci√≥n</div>
                <div class="card-body">
                    <div class="card-score" id="scoreAutenticacion">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedAutenticacion">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalAutenticacion">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="category-card" onclick="openModal('moviles')">
                <div class="card-header"><span class="icon">üì±</span> M√≥viles</div>
                <div class="card-body">
                    <div class="card-score" id="scoreMoviles">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedMoviles">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalMoviles">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="category-card" onclick="openModal('pc')">
                <div class="card-header"><span class="icon">üíª</span> PC y Escritorio</div>
                <div class="card-body">
                    <div class="card-score" id="scorePC">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedPC">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalPC">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="category-card" onclick="openModal('navegacion')">
                <div class="card-header"><span class="icon">üåê</span> Navegaci√≥n Web</div>
                <div class="card-body">
                    <div class="card-score" id="scoreNavegacion">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedNavegacion">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalNavegacion">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="category-card" onclick="openModal('correo')">
                <div class="card-header"><span class="icon">üìß</span> Correo Electr√≥nico</div>
                <div class="card-body">
                    <div class="card-score" id="scoreCorreo">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedCorreo">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalCorreo">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="category-card" onclick="openModal('respaldo')">
                <div class="card-header"><span class="icon">üíæ</span> Respaldo</div>
                <div class="card-body">
                    <div class="card-score" id="scoreRespaldo">0%</div>
                    <div class="card-details">
                        <div class="detail-group">
                            <span id="checkedRespaldo">0</span>
                            <span>Completados</span>
                        </div>
                        <div class="detail-group">
                            <span id="totalRespaldo">0</span>
                            <span>Totales</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="checklistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Categor√≠a</h2>
                <div class="modal-score-header">
                    Puntuaci√≥n: <span id="modalSectionScore" class="score-display">0%</span>
                </div>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                </div>
            <div class="modal-footer">
                <button class="modal-button clear-button" onclick="clearCurrentSection()">Limpiar Selecci√≥n</button>
                <button class="modal-button save-button" onclick="saveAndCloseModal()">Guardar y Cerrar</button>
            </div>
        </div>
    </div>
    
    <div id="hiddenChecklistData" style="display: none;">
        <section data-sectionname="autenticacion" data-title="Checklist de Autenticaci√≥n">
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="auth_1"><span class="item-title">Usar Contrase√±as Fuertes</span><span class="item-detail">Combina may√∫sculas, min√∫sculas, n√∫meros y s√≠mbolos (m√≠nimo 12 caracteres).</span>
            </div>
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="auth_2"><span class="item-title">Habilitar 2FA</span><span class="item-detail">Activa la Autenticaci√≥n de Dos Factores (2FA) en todas las cuentas sensibles.</span>
            </div>
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="auth_3"><span class="item-title">Usar Administrador de Contrase√±as</span><span class="item-detail">Utiliza un gestor de contrase√±as dedicado para almacenar y generar credenciales.</span>
            </div>
            <div class="checklist-item" data-item-level="avanzado">
                <input type="checkbox" id="auth_4"><span class="item-title">Usar 2FA sin SMS</span><span class="item-detail">Prefiere aplicaciones de autenticaci√≥n (ej. Authy, Google Auth) o llaves f√≠sicas (YubiKey) sobre SMS.</span>
            </div>
            <div class="checklist-item" data-item-level="avanzado">
                <input type="checkbox" id="auth_5"><span class="item-title">Revisar Sesiones Activas</span><span class="item-detail">Peri√≥dicamente, revisa y cierra las sesiones activas en tus cuentas importantes.</span>
            </div>
            <div class="checklist-item" data-item-level="opcional">
                <input type="checkbox" id="auth_6"><span class="item-title">Contrase√±as Passphrase</span><span class="item-detail">Usa frases de contrase√±a largas y memorables en lugar de contrase√±as aleatorias.</span>
            </div>
        </section>
        
        <section data-sectionname="moviles" data-title="Checklist de Dispositivos M√≥viles">
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="movil_1"><span class="item-title">Bloqueo Biom√©trico o PIN</span><span class="item-detail">Configura un PIN, patr√≥n o bloqueo biom√©trico fuerte en el m√≥vil.</span>
            </div>
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="movil_2"><span class="item-title">Actualizaciones Autom√°ticas</span><span class="item-detail">Mant√©n el sistema operativo y las aplicaciones actualizadas autom√°ticamente.</span>
            </div>
            <div class="checklist-item" data-item-level="avanzado">
                <input type="checkbox" id="movil_3"><span class="item-title">Permisos de Aplicaciones</span><span class="item-detail">Revisa y limita los permisos de las aplicaciones a lo estrictamente necesario (ej. no dar acceso a micr√≥fono a juegos).</span>
            </div>
            <div class="checklist-item" data-item-level="avanzado">
                <input type="checkbox" id="movil_4"><span class="item-title">Borrado Remoto Activado</span><span class="item-detail">Activa la funci√≥n de "encontrar/borrar mi dispositivo" en caso de p√©rdida o robo.</span>
            </div>
            <div class="checklist-item" data-item-level="opcional">
                <input type="checkbox" id="movil_5"><span class="item-title">VPN en Redes P√∫blicas</span><span class="item-detail">Utiliza una VPN siempre que te conectes a redes Wi-Fi p√∫blicas.</span>
            </div>
        </section>

        <section data-sectionname="pc" data-title="Checklist de PC y Escritorio">
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="pc_1"><span class="item-title">Antivirus y Anti-Malware</span><span class="item-detail">Utiliza un software de seguridad (Antivirus/EDR) actualizado.</span>
            </div>
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="pc_2"><span class="item-title">Firewall Activado</span><span class="item-detail">Aseg√∫rate de que el firewall del sistema operativo est√© activado.</span>
            </div>
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="pc_3"><span class="item-title">Bloqueo de Pantalla</span><span class="item-detail">Configura el bloqueo de pantalla autom√°tico despu√©s de un corto periodo de inactividad.</span>
            </div>
            <div class="checklist-item" data-item-level="avanzado">
                <input type="checkbox" id="pc_4"><span class="item-title">Cifrado de Disco (Full Disk Encryption)</span><span class="item-detail">Cifra el disco duro principal (ej. BitLocker en Windows, FileVault en macOS).</span>
            </div>
            <div class="checklist-item" data-item-level="opcional">
                <input type="checkbox" id="pc_5"><span class="item-title">Cuenta de Usuario Est√°ndar</span><span class="item-detail">Usa una cuenta de usuario sin permisos de administrador para el uso diario.</span>
            </div>
        </section>

        <section data-sectionname="navegacion" data-title="Checklist de Navegaci√≥n Web">
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="nav_1"><span class="item-title">Extensiones M√≠nimas</span><span class="item-detail">Instala solo extensiones esenciales y desinstala las que no uses.</span>
            </div>
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="nav_2"><span class="item-title">Bloqueador de Anuncios/Trackers</span><span class="item-detail">Usa un bloqueador para reducir la exposici√≥n a anuncios maliciosos y seguimiento.</span>
            </div>
            <div class="checklist-item" data-item-level="avanzado">
                <input type="checkbox" id="nav_3"><span class="item-title">Revisi√≥n de URL (Phishing)</span><span class="item-detail">Siempre verifica la URL antes de ingresar credenciales, buscando el candado (HTTPS).</span>
            </div>
            <div class="checklist-item" data-item-level="opcional">
                <input type="checkbox" id="nav_4"><span class="item-title">Navegador Enfocado en Privacidad</span><span class="item-detail">Considera navegadores como Firefox, Brave o Tor para tareas sensibles.</span>
            </div>
        </section>

        <section data-sectionname="correo" data-title="Checklist de Correo Electr√≥nico">
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="mail_1"><span class="item-title">Doble Factor en el Correo Principal</span><span class="item-detail">Asegura la cuenta de correo principal con la 2FA m√°s fuerte disponible (Ej. FIDO2).</span>
            </div>
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="mail_2"><span class="item-title">Precauci√≥n con Archivos Adjuntos</span><span class="item-detail">Nunca abras archivos adjuntos de remitentes desconocidos o sospechosos.</span>
            </div>
            <div class="checklist-item" data-item-level="avanzado">
                <input type="checkbox" id="mail_3"><span class="item-title">Revisar Encabezados de Correo (Phishing)</span><span class="item-detail">Aprende a revisar los encabezados de correo para identificar la fuente real y detectar suplantaci√≥n.</span>
            </div>
            <div class="checklist-item" data-item-level="opcional">
                <input type="checkbox" id="mail_4"><span class="item-title">Correo Desechable para Registros no Confidenciales</span><span class="item-detail">Usa servicios de correo temporal o alias para registros donde la privacidad no es cr√≠tica.</span>
            </div>
        </section>

        <section data-sectionname="respaldo" data-title="Checklist de Respaldo de Informaci√≥n">
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="backup_1"><span class="item-title">Copia de Seguridad 3-2-1</span><span class="item-detail">Aplica la regla 3-2-1: 3 copias, 2 medios diferentes, 1 copia off-site (nube o externo desconectado).</span>
            </div>
            <div class="checklist-item" data-item-level="basico">
                <input type="checkbox" id="backup_2"><span class="item-title">Prueba Peri√≥dica de Restauraci√≥n</span><span class="item-detail">Verifica que puedes restaurar tus archivos desde la copia de seguridad.</span>
            </div>
            <div class="checklist-item" data-item-level="avanzado">
                <input type="checkbox" id="backup_3"><span class="item-title">Respaldo Cifrado</span><span class="item-detail">Cifra las copias de seguridad antes de subirlas a la nube o almacenarlas en medios externos.</span>
            </div>
            <div class="checklist-item" data-item-level="avanzado">
                <input type="checkbox" id="backup_4"><span class="item-title">Respaldo Inmutable (Versioning)</span><span class="item-detail">Utiliza un sistema de respaldo que mantenga versiones o que sea inmutable contra ransomware.</span>
            </div>
            <div class="checklist-item" data-item-level="opcional">
                <input type="checkbox" id="backup_5"><span class="item-title">Almacenamiento Desconectado (Air-gapped)</span><span class="item-detail">Mant√©n un medio de respaldo f√≠sico totalmente desconectado de la red para m√°xima protecci√≥n.</span>
            </div>
        </section>
    </div>

    <script>
        // **********************************************
        // 1. L√ìGICA DEL CHECKLIST (Datos, Persistencia, Gr√°ficas)
        // **********************************************

        const allChecklistData = {};
        const allLevels = ['basico', 'avanzado', 'opcional'];
        const totalItemsInLevel = {};
        const checkedItemsInLevel = {};
        let currentSection = ''; 

        // 1.1 Cargar datos del HTML a la estructura JS
        document.querySelectorAll('#hiddenChecklistData section').forEach(section => {
            const name = section.dataset.sectionname;
            const title = section.dataset.title;
            const items = [];
            section.querySelectorAll('.checklist-item').forEach(item => {
                const level = item.dataset.itemLevel;
                // El input de checkbox dentro del item contiene el ID y los otros elementos contienen el texto
                const checkbox = item.querySelector('input[type="checkbox"]');
                const titleText = item.querySelector('.item-title').textContent;
                const detailText = item.querySelector('.item-detail').textContent;

                items.push({
                    id: checkbox.id,
                    title: titleText,
                    detail: detailText,
                    level: level,
                    checked: false // Inicialmente falso, se carga de localStorage despu√©s
                });

                totalItemsInLevel[level] = (totalItemsInLevel[level] || 0) + 1;
            });
            allChecklistData[name] = { name, title, items };
        });

        // 1.2 Funciones de Utilidad
        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function getSectionIdSuffix(sectionName) {
            // FIX para 'pc' que en HTML es 'PC' (todo may√∫sculas)
            if (sectionName === 'pc') {
                return 'PC';
            }
            // Uso de PascalCase est√°ndar para el resto
            return capitalize(sectionName);
        }
        
        /**
         * Obtiene la informaci√≥n de cumplimiento de cada secci√≥n.
         */
        function getSectionScores() {
            const scores = [];
            let totalChecked = 0;
            let totalTotal = 0;
            
            for (const sectionName in allChecklistData) {
                const section = allChecklistData[sectionName];
                let checkedInSection = 0;
                let totalInSection = section.items.length;

                section.items.forEach(item => { 
                    if (item.checked) checkedInSection++; 
                });
                
                totalChecked += checkedInSection;
                totalTotal += totalInSection;
                
                const score = totalInSection > 0 ? Math.round((checkedInSection / totalInSection) * 100) : 0;
                
                scores.push({
                    name: section.title.replace('Checklist de ', ''),
                    compliance: score,
                    total: totalInSection,
                    checked: checkedInSection
                });
            }
            
            const promedioGeneral = totalTotal > 0 ? Math.round((totalChecked / totalTotal) * 100) : 0;
            
            return { scores, promedioGeneral };
        }


        // 1.3 L√≥gica de Persistencia y Actualizaci√≥n (Gr√°ficas y Scores)
        function updateTotals() {
            let totalChecked = 0;
            let totalTotal = 0;

            allLevels.forEach(level => checkedItemsInLevel[level] = 0);

            for (const sectionName in allChecklistData) {
                const section = allChecklistData[sectionName];
                let checkedInSection = 0;
                let totalInSection = section.items.length;

                section.items.forEach(item => {
                    if (item.checked) {
                        checkedInSection++;
                        totalChecked++;
                        checkedItemsInLevel[item.level] = (checkedItemsInLevel[item.level] || 0) + 1;
                    }
                });

                totalTotal += totalInSection;
                const score = totalInSection > 0 ? Math.round((checkedInSection / totalInSection) * 100) : 0;
                
                // Determinar la clase de color/gravedad
                let scoreClass = 'high';
                if (score <= 30) {
                    scoreClass = 'low';
                } else if (score < 70) {
                    scoreClass = 'medium';
                }

                const suffix = getSectionIdSuffix(sectionName); 
                
                // Actualizar Tarjetas
                const scoreElement = document.getElementById(`score${suffix}`);
                const checkedElement = document.getElementById(`checked${suffix}`);
                const totalElement = document.getElementById(`total${suffix}`);

                if (scoreElement) {
                    scoreElement.textContent = `${score}%`;
                    // Asegurar que el elemento padre de la tarjeta tambi√©n refleje el color para accesibilidad.
                    scoreElement.className = `card-score ${scoreClass}`;
                }
                if (checkedElement) checkedElement.textContent = checkedInSection;
                if (totalElement) totalElement.textContent = totalInSection;
            }

            // Actualizar Resumen General
            const promedioGeneral = totalTotal > 0 ? Math.round((totalChecked / totalTotal) * 100) : 0;
            document.getElementById('promedioGeneral').textContent = `${promedioGeneral}%`;
            document.getElementById('totalCheckedItems').textContent = totalChecked;
            document.getElementById('totalItems').textContent = totalTotal;
            
            updateDonutCharts();
            updateRadarChart();
            saveState(); // Guardar el estado despu√©s de cada actualizaci√≥n
        }

        // 1.4 L√≥gica de Gr√°ficos (Donut Charts)
        function updateDonutCharts() {
            const circumference = 282.7; // 2 * PI * 45 (radio)
            allLevels.forEach(level => {
                const total = totalItemsInLevel[level] || 1;
                const checked = checkedItemsInLevel[level] || 0;
                const percentage = Math.round((checked / total) * 100);
                const offset = circumference - (percentage / 100) * circumference;

                const percentElement = document.getElementById(`donutPercent${capitalize(level)}`);
                if (percentElement) percentElement.textContent = `${percentage}%`;
                
                const circle = document.getElementById(`donutCircle${capitalize(level)}`);
                if (circle) circle.style.strokeDashoffset = offset;
            });
        }

        // 1.5 L√≥gica de Gr√°ficos (Radar Chart)
        function updateRadarChart() {
            const svg = document.getElementById('cyberRadarChart');
            const data = {};
            
            for (const sectionName in allChecklistData) {
                const section = allChecklistData[sectionName];
                let checkedInSection = 0;
                let totalInSection = section.items.length;
                section.items.forEach(item => { if (item.checked) checkedInSection++; });
                data[sectionName] = totalInSection > 0 ? (checkedInSection / totalInSection) : 0;
            }

            const sections = Object.keys(data);
            const numSections = sections.length;
            if (numSections === 0) return;

            const radius = 90;
            const center = 100;
            const angleStep = (2 * Math.PI) / numSections;

            // Limpiar solo los elementos din√°micos (ejes y figura)
            let dynamicElements = Array.from(svg.children).filter(child => 
                child.classList.contains('radar-axis') || child.classList.contains('radar-shape') || child.classList.contains('radar-label')
            );
            dynamicElements.forEach(el => el.remove());

            let points = "";

            // Dibujar la figura del radar (la puntuaci√≥n) y los ejes/etiquetas
            for (let i = 0; i < numSections; i++) {
                const angle = i * angleStep - Math.PI / 2;
                const sectionName = sections[i];
                const score = data[sectionName] || 0;
                const r = radius * score;
                const x = center + r * Math.cos(angle);
                const y = center + r * Math.sin(angle);
                points += `${x},${y} `;
                
                // Dibujar l√≠neas de eje y etiquetas (Asegurarse de que se dibujan solo una vez)
                // Se dejaron los ejes en el bucle anterior, voy a reinsertar los ejes para que est√©n sobre el pol√≠gono si es necesario
                const endX = center + radius * Math.cos(angle);
                const endY = center + radius * Math.sin(angle);
                
                // L√≠nea de Eje
                const axisLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                axisLine.setAttribute('x1', center);
                axisLine.setAttribute('y1', center);
                axisLine.setAttribute('x2', endX);
                axisLine.setAttribute('y2', endY);
                axisLine.setAttribute('class', 'radar-axis');
                // Insertar antes del pol√≠gono para que el pol√≠gono est√© encima
                svg.appendChild(axisLine);
                
                // Etiqueta
                const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
                const labelX = center + (radius * 1.1) * Math.cos(angle);
                const labelY = center + (radius * 1.1) * Math.sin(angle);

                label.setAttribute('x', labelX);
                label.setAttribute('y', labelY);
                label.setAttribute('class', 'radar-label');
                // Ajuste de anclaje para que las etiquetas no se solapen
                let anchor = 'middle';
                if (Math.cos(angle) > 0.1) anchor = 'start';
                if (Math.cos(angle) < -0.1) anchor = 'end';
                
                label.setAttribute('text-anchor', anchor);
                label.textContent = capitalize(sectionName);
                svg.appendChild(label);
            }

            // Dibujar el pol√≠gono (la forma del score)
            const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            polygon.setAttribute('points', points);
            polygon.setAttribute('class', 'radar-shape');
            svg.appendChild(polygon);
        }
        
        // 1.6 L√≥gica del Modal
        function openModal(sectionName) {
            currentSection = sectionName;
            const modal = document.getElementById('checklistModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            const section = allChecklistData[sectionName];
            modalTitle.textContent = section.title;
            
            let htmlContent = '';
            let checkedCount = 0;

            section.items.forEach(item => {
                const isChecked = item.checked;
                if (isChecked) checkedCount++;
                
                // Clase 'completed' para estilos visuales dentro del modal
                htmlContent += `
                    <div class="checklist-item ${isChecked ? 'completed' : ''}" data-item-id="${item.id}">
                        <div class="checklist-row">
                            <input type="checkbox" id="modal_${item.id}" ${isChecked ? 'checked' : ''} onchange="updateModalScore('${sectionName}')">
                            <label for="modal_${item.id}" class="item-title">${item.title}</label>
                            <span class="level-tag level-${item.level}">${capitalize(item.level)}</span>
                        </div>
                        <div class="item-detail">${item.detail}</div>
                    </div>
                `;
            });

            modalBody.innerHTML = htmlContent;
            updateModalScore(sectionName, checkedCount);
            modal.style.display = 'block';
        }

        function updateModalScore(sectionName, initialCheckedCount) {
            const section = allChecklistData[sectionName];
            let checkedCount = initialCheckedCount !== undefined ? initialCheckedCount : 0;
            const total = section.items.length;
            const modalBody = document.getElementById('modalBody');
            
            if (initialCheckedCount === undefined) {
                // Si no se pasa el conteo inicial, lo calculamos en vivo desde los checkboxes del modal
                checkedCount = 0;
                modalBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    if (checkbox.checked) {
                        checkedCount++;
                        // Actualiza el estilo del elemento padre al cambiar el checkbox
                        const itemElement = checkbox.closest('.checklist-item');
                        if (itemElement) {
                            itemElement.classList.toggle('completed', checkbox.checked);
                        }
                    }
                });
            }

            const score = total > 0 ? Math.round((checkedCount / total) * 100) : 0;
            document.getElementById('modalSectionScore').textContent = `${score}%`;
        }

        function saveAndCloseModal() {
            const modalBody = document.getElementById('modalBody');
            const section = allChecklistData[currentSection];

            section.items.forEach(item => {
                const checkbox = modalBody.querySelector(`#modal_${item.id}`);
                // Actualizar el estado del objeto en JS
                if (checkbox) {
                    item.checked = checkbox.checked;
                }
            });

            updateTotals();
            closeModal();
        }
        
        function clearCurrentSection() {
            const modalBody = document.getElementById('modalBody');
            modalBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                const itemElement = checkbox.closest('.checklist-item');
                if (itemElement) {
                    itemElement.classList.remove('completed');
                }
            });
            updateModalScore(currentSection, 0); 
        }

        function closeModal() {
            document.getElementById('checklistModal').style.display = 'none';
        }

        function loadState() {
            const savedState = localStorage.getItem('cybersecurityChecklistState');
            if (savedState) {
                const loadedData = JSON.parse(savedState);
                for (const sectionName in loadedData) {
                    if (allChecklistData[sectionName]) {
                        loadedData[sectionName].items.forEach((loadedItem, index) => {
                            if (allChecklistData[sectionName].items[index]) {
                                // Copiar solo el estado 'checked'
                                allChecklistData[sectionName].items[index].checked = loadedItem.checked;
                            }
                        });
                    }
                }
            }
        }

        function saveState() {
            // Guardar solo la informaci√≥n esencial y el estado 'checked'
            const stateToSave = {};
            for (const sectionName in allChecklistData) {
                stateToSave[sectionName] = {
                    items: allChecklistData[sectionName].items.map(item => ({
                        id: item.id,
                        checked: item.checked
                    }))
                };
            }
            localStorage.setItem('cybersecurityChecklistState', JSON.stringify(stateToSave));
        }
        
        // **********************************************
        // 2. L√ìGICA DE GENERACI√ìN DE PDF Y GOOGLE SHEETS
        // **********************************************
        
        // ** CAMBIA ESTA URL por la que obtengas al desplegar el Apps Script **
        const GAS_WEB_APP_URL = 'https://script.google.com/a/macros/energiasolarsa.com/s/AKfycbwu0pSdKjWs1oMwuD0c8x_JQNTcHUg1uPXF4_qCw8ex2yYmVPa1KlLu9tL-iNTx49wm/exec'; 

        /**
         * @function sendToGoogleSheet
         * Env√≠a los datos de cumplimiento a la hoja de Google Sheets a trav√©s del Apps Script.
         */
        function sendToGoogleSheet(userName, dateString, scoresData) {
            // Verificaci√≥n simplificada de URL
            if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL.includes('AKfycb')) {
                console.warn("ADVERTENCIA: La URL de Google Apps Script no ha sido configurada. Los datos NO se guardar√°n. Por favor, sigue las instrucciones de configuraci√≥n.");
                alert("Advertencia: No se guardaron los datos. Debes configurar la URL de Google Apps Script.");
                return;
            }

            const payload = {
                userName: userName,
                date: dateString,
                generalScore: scoresData.promedioGeneral,
                scores: scoresData.scores.map(s => ({
                    name: s.name,
                    compliance: s.compliance
                }))
            };
            
            // Se usa mode: 'no-cors' para asegurar el env√≠o a Apps Script
            fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(() => {
                console.log('Datos de cumplimiento enviados a Google Sheets. (El navegador no puede confirmar la recepci√≥n)');
            })
            .catch(error => {
                console.error('Error al enviar datos a Google Sheets:', error);
            });
        }


        /**
         * @function generatePDF
         * Recopila datos, los env√≠a a Google Sheets y activa la impresi√≥n.
         */
        function generatePDF() {
            // 1. Pedir el nombre de usuario
            const userName = prompt("Por favor, introduce tu nombre para el informe y para guardar el registro:");
            
            if (!userName || userName.trim() === "") {
                alert("La generaci√≥n del reporte ha sido cancelada.");
                return;
            }
            
            const nameToDisplay = userName.trim();
            
            // 2. Obtener la fecha de hoy
            const today = new Date();
            const dateString = today.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // 3. Obtener todos los scores y el promedio general
            const scoresData = getSectionScores();
            const scores = scoresData.scores;
            const promedioGeneral = scoresData.promedioGeneral;

            // 4. Inyectar datos en el encabezado del reporte (para impresi√≥n)
            document.getElementById('reportUserName').textContent = nameToDisplay;
            document.getElementById('reportDate').textContent = dateString;
            document.getElementById('reportGeneralScore').textContent = `${promedioGeneral}%`;

            // 5. Inyectar la lista de scores por categor√≠a
            let scoresHtml = '<ul>';
            scores.forEach(score => {
                scoresHtml += `<li>${score.name} <span>${score.compliance}%</span></li>`;
            });
            scoresHtml += '</ul>';
            
            document.getElementById('reportDetails').innerHTML = `
                <h3 style="color: #1A3E60; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; font-size: 1.2em;">Cumplimiento por Categor√≠a</h3>
                ${scoresHtml}
            `;

            // 6. Enviar datos a Google Sheets (As√≠ncrono)
            sendToGoogleSheet(nameToDisplay, dateString, scoresData);
            
            // 7. Iniciar la impresi√≥n (navegador)
            // Peque√±o retraso para que el navegador procese el cambio de estilos de impresi√≥n
            setTimeout(() => {
                window.print();
            }, 100); 
        }

        // Inicializaci√≥n de la aplicaci√≥n
        // Asegurar que se cargan los datos y se actualiza la interfaz al inicio
        loadState();
        updateTotals(); 
    </script>
    
    </body>
</html>
